# Агрегация и Групи

---
## Агрегация

- Взимаме всичките стойности на една колона и ги свеждаме до една стойност
- MySQL предоставя богат набор от агрегатни функции

---
## COUNT

- `COUNT(*)` - Намираме броят редове на дадена заявка
- Примери: Намерете броят ученици.

---

```sql
SELECT COUNT(*) FROM students;
```

---

- `COUNT(<column>)` - Намира броят на стойностите на `<column>`, които не са `null`
- Пример: Намерете броят ученици, които имат оценка.

---

```sql
SELECT COUNT(gpa) FROM students;
```

---
## SUM

- Сумира стойностите на дадена колона
- Пример: Намерете колко пари се дават за заплати всеки месец
---

```sql
SELECT SUM(salary) FROM teachers;
```

---
## AVG

- Намира средно аритметичното на стойностите на дадена колона
- Пример: Намерете средният успех на всички ученици

---

```sql
SELECT AVG(gpa) FROM students;
```

---
## MIN

- Намира най-малката стойност на дадена колона
- Пример: Намерете най-малкият среден успех на учениците

---

```sql
SELECT MIN(gpa) FROM students;
```

---
## MAX

- Намира най-голямата стойност на дадена колона
- Пример: Намерете най-големият среден успех на учениците
---

```sql
SELECT MAX(gpa) FROM students;
```

---

## GROUP BY

- До тук всяка функция намира агрегат за цялата таблица
- Използвайки `GROUP BY`, ние можем да групираме таблицата спрямо дадена колона и да намерим агрегат за всяка група

---

## GROUP BY - Синтаксис

```mysql
SELECT column_name(s)
FROM table_name
WHERE condition
GROUP BY column_name(s);
```

---

## GROUP BY - Примери

- Намерете колко ученици има във всеки клас
- Намерете средният успех на всеки клас

---

- Намерете всеки учител колко предмета води
- Намерете за всеки предмет средната заплата на учителите които го водят

---

## GROUP BY с две колони

- При групиране на таблица можем да използваме повече от една групираща колона
- Таблицата тогава ще се раздели спрямо различните комбинации на стойностите на групиращите колони

---

## GROUP BY с две колони - Пример

- Към таблицата `students` искаме да добавим колона `class_group`, която определя в коя група е този ученик - 1-ва или 2-ра
- Ние тогава можем да намерим информация за всяка група, например колко ученика има в тях

---

```sql
CREATE TABLE students(
    number INT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    gpa FLOAT,
    email VARCHAR(255) NOT NULL UNIQUE,
    class_number INT NOT NULL,
    group_number ENUM('1','2'),
    FOREIGN KEY (class_number) REFERENCES classes(number)
)
```

---

```sql
SELECT class_number, group_number, count(*) students FROM students
GROUP BY class_number, group_number;
```
---

## HAVING

- Прилагаме ограничение върху групите, които ще се изведат в заявката.
- Пример: Намерете учителите, които водят 2 или повече предмета

---

```mysql
SELECT t.name, COUNT(*) subjects FROM
teachers t JOIN subjects_teachers st
ON t.id = st.subject_id
GROUP BY t.id
HAVING subjects >= 2;
```
