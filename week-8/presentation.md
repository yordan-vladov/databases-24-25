# Подзаявки

---
## Съдържание

- Подзаявки
- Видове подзаявки
- Операторите **IN** и **EXISTS**
- Взаимосвързани заявки
---
## База данни

![](/Attachments/company.png)

---
## Какво е подзаявка?

- Използваме резултатът от една заявка  в друга заявка.
- Заявката, която използваме като резултат трябва да се огради с кръгли скоби.
- Алтернатива на **JOIN**
---
## Подзаявка - Пример

- Искаме да намерим служителите с най-висока заплата.
- За тази цел трябва да намерим най-високата заплата и да намерим служителите, които имат заплата, равна на най-голямата.
---
```sql
SELECT * FROM employees
WHERE salary = (
	SELECT MAX(salary) FROM employees
);
```
---
- Намерете служителите с най-малка заплата
- Намерете служителите със заплата над средната
---
## Видове подзаявки

- **Скаларни** - връщат една стойност
- **Колонни** - връщат колона с 0 или повече стойности
- **Таблични** - връщат таблица с редове и колони
---
## Скаларни

- Подзаявката връща една стойносто (число, текст, др.)
- Горната заявка използва аритметични оператори (=,>,<,...) при сравнение с подзаявката
- Примерите, които разглеждахме до сега
---
## Колонни

- Подзаявката връща колона от стойности
- Горната може да използва оператори като **IN** при сравнение с подзаявката
---
## Колонна подзаявка - Пример

- Искаме да намерим служителите, които работят в "Sales"
- За целта трябва да намерим id на отделите "Sales" и да намерим служителите с "department_id", който попада в намерените
---
```sql
SELECT * FROM employees
WHERE department_id IN
(SELECT department_id FROM departments
WHERE name = "Sales");
```
---
- Намерете всички мениджъри
- Намерете служителите, които живеят в София
- Намерете проектите, по които никой не работи
---
## Таблични

- Подзаявката връща повече от една колона
- Пример:  Намерете служителите, които работят за главата на "Sales"
---

```sql
SELECT * FROM employees
WHERE (department_id, manager_id)
IN (
SELECT department_id, manager_id FROM
departments WHERE name = 'Sales');
```
---
# Взаимосвързани заявки
---
## Какво са Взаимосвързани заявки?

- Таблиците от външния **SELECT** може да бъдат споменати във вътрешния **SELECT** чрез псевдоними и използвани в неговите условия. Такива заявки наричаме взаимосвързани.

---
- Пример: намерете най-високата заплата от всеки отдел и работника, който я получава

```sql
SELECT * FROM employees e
WHERE salary = (
	SELECT salary FROM employees
    WHERE department_id = e.department_id
    ORDER BY salary DESC LIMIT 1
);
```
---
## Необвързани заявки

- При други подзаявки вътрешния **SELECT** не ползва външния и може да бъде ползван самостоятелно. Такива заявки наричаме необвързани.
---
- Пример: намерете най-високата заплата от всички отдели и изведете информация за работника, който я получава
```sql
SELECT * FROM employees e
WHERE (department_id, salary) IN (
	SELECT department_id, MAX(salary) salary
    FROM employees GROUP BY department_id
);
```
---
## Оператор EXISTS

- При **EXISTS** условието е вярно, ако подзаявката връща записи
    - Пример: изведете всички служители от отдел финанси
```sql
SELECT * FROM employees e
WHERE EXISTS (
	SELECT d.department_id FROM departments d
    WHERE e.department_id = d.department_id
    AND d.name = 'Finance'
);
```

---
- При **NOT EXISTS** е вярно, ако подзаявката е празна
- И двата оператора се ползват с взаимосвързани заявки
---
## Задача: Служители с мениджъри от отдел 1

- Изведете списък на всички служители с мениджъри от отдел 1
    - Намираме всички служители от отдел 1
    - Извеждаме служителите с мениджър някой от горните

---
- Решение с взаимозависима заявка и **EXISTS**:

```sql
SELECT * FROM employees e WHERE EXISTS
(SELECT employee_id FROM employees m
WHERE m.employee_id = e.manager_id AND m.department_id = 1
);
```

---
- Решение с необвързана подзаявка и **IN**:

```sql
SELECT * FROM employees e WHERE manager_id
IN (select employee_id FROM employees WHERE department_id = 1);
```
