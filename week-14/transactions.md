# Транзакции

---
## Съдържание

- Какво е транзакция?
- ACID Принципи.
---
### Какво е транзакция?

- Извършваме множество операции и ги записваме наведнъж в базата данни.
- Гарантираме последователността в нашата база данни.
---
### Транзакция - пример

- База данни на банкова система.
- Потребителят **Иванка** трансферира 100 лв. на **Стамат**.
- Транзакцията има две части:
    - Вземи 100 лв. от сметката на **Иванка**.
    - Добави 100 лв. към сметката на **Стамат**.
---
- При една транзакция всички операции трябва да са успешни, за да може тя да завърши.
- Ако една от операциите се провали, тогава всички операции трябва да се отменят.
---
![](/Attachments/DB-Transcations-Pic-1.png)

---
### Атомарност

- Всички промени, направени по време на тази транзакция, се третират като един "пакет" от промени.
- **Пример:** Банковата транзакция от горният слайд.
---
### Последователност

- Данните, съхранявани в базата данни, винаги са във валидно и последователно състояние.
- Спазват се типове данни на колони, както и ограничения (**PRIMARY KEY**, **UNIQUE**, **NOT NULL**, ...).
---
- След всяко успешно записване, актуализиране или изтриване на запис, всяка заявка за четене незабавно получава последната стойност на записа.
- Когато една транзакция се запише, всички бъдещи транзакции ще знаят за нея.
---
### Изолация

- Способността на множество транзакции да се изпълняват едновременно, без да си пречат една на друга.
- Нивото на изолация на транзакция определя как промените, направени от тази транзакция, са видими за други транзакции.
---
- Нивото на изолация на една транзакция може да се определи от това колко е устойчива към следните феномени:
    - Мръсно четене (Dirty Read)
    - Фантомно четене (Phantom Read)
    - Неповторимо четене (Non-repeatable read)
---
###  Мръсно четене

- Транзакция чете данни, които все още не са записани.
- T1 актуализира ред и го оставя незаписан, междувременно T2 чете актуализирания ред.
- Ако T1 отмени промяната, T2 ще прочете данни, за които се счита, че никога не са съществували.
---
![](/Attachments/DB-Transcations-Pic-2.png)

---
### Фантомно четене

- Една и съща заявка връща различни резултати.
- Т1 чете записи, но друга транзакция Т2 вмъква или изтрива редове в записите, които се четат.
- Когато Т1 прочете същите редове отново, ще бъде открит нов ред "фантом".
---
![](/Attachments/DB-Transcations-Pic-3.png)

---
###  Непoвторимо четене

- Транзакция чете един и същ ред два пъти и получава различна стойност всеки път.
- Това става ако друга транзакция преждевременно актуализира тези данни.
---
### Устойчивост

- Данните остават в безопасност, дори в случай на непредвидени обстоятелства.
- Когато транзакция е извършена, нейните промени трябва да останат в базата данни, дори ако претърпи неизправност или прекъсване на захранването.
---
### Write Ahead Log

- Файл, в който се записва история на промените на базата данни.
- Транзакция трябва да се запише във **WAL**, преди да приключи.
- Когато една база данни се срине, тя може да се възстанови от **WAL**.
