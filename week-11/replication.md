# Репликация
---
## Съдържание
- Какво е репликация?
- Видове репликация.
- Репликация в MySQL
---
### Какво е репликация?
- Пазим копия на едни и същи данни върху множество устройства.
- Предимство е ако устройствата могат автоматично да се репликират.
---
### Репликация - предимства
- Данните да се пазят географски близо до потребителите.
- Системата да продължи да работи дори ако някои от компонентите ѝ са се провалили.
- Броят машини, които могат да отговарят на `select` заявки да се увеличи.
---
### Лидери и последователи
- Начин, по който да осигурим че всички данни се озовават във всички реплики.
---
### Лидерна репликация
1. Една от репликите е лидер. Записите към базата данни се прават през нея.
2. Другите реплики за последователи. Те взимат актуалните данни от лидера.
3. Четения могат да се правят през всички реплики. Писания само от лидера.
---
![](/Attachments/DB_Replication_1.png)

---
### Синхронна, Асинхронна репликация

- **Синхронна** - лидерът чака отговор от репликата, преди да продължи своята работа.
- **Асинхронна** - лидерът изпраща промените към репликата, без да чака отговор.
---
![](/Attachments/DB_Replication_2.png)

---
- При напълно синхронна репликация потребителят винаги ще достъпва актуални данни, но всеки запис може да е значително по-бавен.
- Ако една реплика не върне отговор, всички други трябва да чакат.
---
- При напълно асинхронна репликация всеки запис ще бъде бърз, но потребителят няма гаранция, че ще достъпва актуални данни.
- Допълнително ако нещо се случи на лидера, няма откъде да се възстановят данните.
---
- Компромисен вариант е да имаме един синхронен и последовател и всички други да са асинхронни.
- Това гарантира, че имаме актуално копие е най-малко два възела: лидерът и синхронният последовател. Тази репликация понякога се нарича *полусинхронна*.
---
### Репликация в MySQL

- MySQL позволява една база данни автоматично да копира друга. В този случай оригиналната база данни се нарича **master**, а копието - **slave**
---
- За да настроим репликация, първо трябва да модифицираме конфигурацията (`my.cnf`) на двете бази данни.
---
- my.cnf (master)
```txt
...
server-id=1
log_bin=mysql-bin.log
bind-address=0.0.0.0
binlog_do_db=db_name
...
```
---
- my.cnf (slave)
```txt
...
server-id=2
log-bin=mysql-bin.log
binlog_do_db=db_name
relay-log=mysql-relay-bin.log
bind-address = 0.0.0.0
...
```
---
 - След това трябва в **master** базата данни да създадем потребител, чрез който **slave** да се свърже и да извършва репликацията.
---
```mysql
CREATE DATABASE abcd;
CREATE USER 'replica_user'@'%' IDENTIFIED BY '1234';
GRANT REPLICATION SLAVE ON *.* TO 'replica_user'@'%';
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
```
---
- Накрая трябва във **slave** базата данни да настроим връзката с **master**.
---
```mysql
CREATE DATABASE abcd;
CHANGE REPLICATION SOURCE TO
SOURCE_HOST='<master-ip-address>',
SOURCE_USER='replica_user',
SOURCE_PORT=3306,
SOURCE_PASSWORD='1234',
SOURCE_LOG_FILE='<master-bin-file>',
SOURCE_LOG_POS='<master-log-pos>';
START SLAVE;
SHOW SLAVE STATUS;
```
---
- След това всички промени, които са се извършвали в **master** ще се пресъздадат и във **slave**.
---
```mysql
CREATE TABLE abcd.users(
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    salary FLOAT
);

INSERT INTO abcd.users(name,salary) VALUES ("Gosho",2000);
```
---
